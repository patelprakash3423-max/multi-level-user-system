<div class="admin-credit-container">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-gradient-credit text-white py-3">
          <div class="d-flex flex-wrap align-items-center justify-content-between">
            <div class="d-flex align-items-center mb-2 mb-md-0">
              <button class="btn btn-light btn-sm me-3" (click)="goBack()">
                <i class="bi bi-arrow-left"></i>
              </button>
              <i class="bi bi-cash-coin fs-1 me-3"></i>
              <div>
                <h2 class="mb-0 fw-bold">Credit Balance</h2>
                <p class="mb-0 opacity-75">
                  Credit balances to any user in the system
                </p>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-light btn-sm" (click)="toggleBulkCredit()">
                <i class="bi bi-people-fill me-1"></i> 
                {{ showBulkCredit ? 'Single Credit' : 'Bulk Credit' }}
              </button>
              <button class="btn btn-light btn-sm" (click)="clearSelection()">
                <i class="bi bi-eraser me-1"></i> Clear
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-4 mb-3">
      <div class="card stat-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-calendar-day fs-3 text-info"></i>
            </div>
            <div>
              <h6 class="text-muted mb-1">Credited Today</h6>
              <h3 class="mb-0 fw-bold">{{ formatCurrency(totalCreditedToday) }}</h3>
              <small class="text-muted">Across all users</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-3">
      <div class="card stat-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-calendar-month fs-3 text-success"></i>
            </div>
            <div>
              <h6 class="text-muted mb-1">This Month</h6>
              <h3 class="mb-0 fw-bold">{{ formatCurrency(totalCreditedThisMonth) }}</h3>
              <small class="text-muted">Total credits</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-3">
      <div class="card stat-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stat-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-arrow-repeat fs-3 text-primary"></i>
            </div>
            <div>
              <h6 class="text-muted mb-1">Total Transactions</h6>
              <h3 class="mb-0 fw-bold">{{ formatNumber(totalTransactions) }}</h3>
              <small class="text-muted">Credit transactions</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Single Credit Section -->
  <div *ngIf="!showBulkCredit" class="row">
    <div class="col-lg-8">
      <!-- Credit Form Card -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light py-3">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-person-plus-fill text-primary me-2"></i>
            Credit to Single User
          </h5>
        </div>
        
        <div class="card-body p-4">
          <!-- User Selection -->
          <div class="mb-4">
            <label class="form-label fw-semibold">
              <i class="bi bi-person-badge me-1"></i>
              Select User
              <span class="text-danger">*</span>
            </label>
            
            <!-- Selected User Display -->
            <div *ngIf="selectedUser" class="selected-user-card bg-light p-3 rounded-3 mb-3">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  <div class="user-avatar me-3" [ngClass]="'bg-' + getAvatarColor(selectedUser.username) + '-subtle'">
                    <span class="avatar-text">{{ getInitials(selectedUser.username) }}</span>
                  </div>
                  <div>
                    <div class="d-flex align-items-center gap-2 mb-1">
                      <span class="fw-bold">{{ selectedUser.username }}</span>
                      <span class="badge" [ngClass]="getRoleBadgeClass(selectedUser.role)">
                        {{ selectedUser.role | titlecase }}
                      </span>
                      <span class="badge bg-secondary">Level {{ selectedUser.level }}</span>
                      <span class="badge" [ngClass]="getStatusBadgeClass(selectedUser.isActive)">
                        {{ selectedUser.isActive ? 'Active' : 'Inactive' }}
                      </span>
                    </div>
                    <div class="text-muted small">
                      <i class="bi bi-envelope me-1"></i> {{ selectedUser.email }} •
                      <i class="bi bi-cash-stack me-1 ms-2"></i> Current Balance: 
                      <span class="fw-bold text-success">{{ formatCurrency(selectedUser.balance) }}</span>
                    </div>
                  </div>
                </div>
                <button class="btn btn-outline-secondary btn-sm" (click)="clearSelection()">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
            </div>
            
            <!-- User Search -->
            <div *ngIf="!selectedUser" class="position-relative">
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0">
                  <i class="bi bi-search"></i>
                </span>
                <input
                  type="text"
                  class="form-control border-start-0 ps-0"
                  placeholder="Search by username, email, or user ID..."
                  [(ngModel)]="searchTerm"
                  (input)="searchUser()"
                  (focus)="showSearchResults = true"
                >
                <button *ngIf="searchTerm" class="btn btn-outline-secondary" type="button" (click)="searchTerm = ''; searchUser()">
                  <i class="bi bi-x"></i>
                </button>
              </div>
              
              <!-- Search Results -->
              <div *ngIf="showSearchResults && searchResults.length > 0" class="search-results card position-absolute w-100 mt-1" style="z-index: 1000;">
                <div class="list-group list-group-flush">
                  <button 
                    *ngFor="let user of searchResults"
                    class="list-group-item list-group-item-action d-flex align-items-center"
                    (click)="selectUser(user)"
                    [disabled]="!canCredit(user)">
                    <div class="user-avatar-sm me-3" [ngClass]="'bg-' + getAvatarColor(user.username) + '-subtle'">
                      <span class="avatar-text">{{ getInitials(user.username) }}</span>
                    </div>
                    <div class="flex-grow-1 text-start">
                      <div class="d-flex align-items-center gap-2">
                        <span class="fw-semibold">{{ user.username }}</span>
                        <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
                          {{ user.role | titlecase }}
                        </span>
                      </div>
                      <small class="text-muted">{{ user.email }} • Level {{ user.level }} • Balance: {{ formatCurrency(user.balance) }}</small>
                    </div>
                    <span *ngIf="!canCredit(user)" class="badge bg-secondary">Cannot Credit</span>
                  </button>
                </div>
              </div>
              
              <div *ngIf="showSearchResults && searchResults.length === 0 && !isSearching && searchTerm" class="search-results card position-absolute w-100 mt-1">
                <div class="list-group-item text-center text-muted py-3">
                  <i class="bi bi-exclamation-circle me-2"></i>
                  No users found
                </div>
              </div>
              
              <div *ngIf="isSearching" class="search-results card position-absolute w-100 mt-1">
                <div class="list-group-item text-center py-3">
                  <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                  Searching...
                </div>
              </div>
            </div>
            
            <div *ngIf="!selectedUser" class="mt-2">
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Search for a user to credit balance. Amount will be deducted from their parent's balance.
              </small>
            </div>
          </div>

          <!-- Parent Info (if available) -->
          <div *ngIf="selectedUser && parentUser" class="parent-info-card bg-light p-3 rounded-3 mb-4">
            <div class="d-flex align-items-center">
              <i class="bi bi-arrow-up-circle-fill text-warning fs-4 me-3"></i>
              <div>
                <span class="fw-semibold d-block">Parent: {{ parentUser.username }}</span>
                <small class="text-muted">
                  Current balance: {{ formatCurrency(parentUser.balance) }} • 
                  After credit: {{ formatCurrency(parentUser.balance - creditForm.get('amount')?.value || 0) }}
                </small>
              </div>
            </div>
          </div>

          <!-- Credit Form -->
          <form [formGroup]="creditForm">
            <div class="row">
              <!-- Amount Field -->
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-currency-dollar me-1"></i>
                  Amount
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light">$</span>
                  <input
                    type="number"
                    class="form-control"
                    formControlName="amount"
                    placeholder="Enter amount"
                    [class.is-invalid]="isFieldInvalid(creditForm, 'amount')"
                    min="1"
                    max="1000000"
                  >
                </div>
                <div *ngIf="isFieldInvalid(creditForm, 'amount')" class="invalid-feedback d-block">
                  {{ getErrorMessage(creditForm, 'amount') }}
                </div>
                
                <!-- Quick Amount Buttons -->
                <div class="quick-amounts mt-2">
                  <small class="text-muted d-block mb-2">Quick amounts:</small>
                  <div class="d-flex flex-wrap gap-2">
                    <button 
                      *ngFor="let amount of quickAmounts"
                      type="button"
                      class="btn btn-outline-secondary btn-sm"
                      (click)="setQuickAmount(amount)">
                      ${{ amount.toLocaleString() }}
                    </button>
                  </div>
                </div>
              </div>

              <!-- Description Field -->
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-chat-text me-1"></i>
                  Description
                  <span class="text-danger">*</span>
                </label>
                <textarea
                  class="form-control"
                  formControlName="description"
                  rows="3"
                  placeholder="Reason for credit (e.g., Bonus, Commission, Adjustment)"
                  [class.is-invalid]="isFieldInvalid(creditForm, 'description')"
                ></textarea>
                <div *ngIf="isFieldInvalid(creditForm, 'description')" class="invalid-feedback d-block">
                  {{ getErrorMessage(creditForm, 'description') }}
                </div>
                <div class="text-end mt-1">
                  <small class="text-muted">
                    {{ creditForm.get('description')?.value?.length || 0 }}/100
                  </small>
                </div>
              </div>

              <!-- Options -->
              <div class="col-12 mb-4">
                <div class="bg-light p-3 rounded-3">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" formControlName="sendNotification">
                        <label class="form-check-label fw-semibold">
                          Send Notification
                        </label>
                        <div class="small text-muted">Notify user via email about this credit</div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" formControlName="requireConfirmation">
                        <label class="form-check-label fw-semibold">
                          Require Confirmation
                        </label>
                        <div class="small text-muted">Show confirmation dialog before processing</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-end gap-2">
              <button 
                type="button" 
                class="btn btn-outline-secondary"
                (click)="clearSelection()">
                <i class="bi bi-x-circle me-2"></i>
                Cancel
              </button>
              
              <button 
                type="button" 
                class="btn btn-primary px-4"
                (click)="previewCredit()"
                [disabled]="!selectedUser || creditForm.invalid || isProcessing">
                <i class="bi bi-eye me-2"></i>
                Preview
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Credit Preview Modal -->
      <div class="modal fade" [class.show]="showPreview" [style.display]="showPreview ? 'block' : 'none'" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content" *ngIf="creditPreview">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">
                <i class="bi bi-eye-fill me-2"></i>
                Preview Credit
              </h5>
              <button type="button" class="btn-close btn-close-white" (click)="closePreview()"></button>
            </div>
            
            <div class="modal-body">
              <div class="text-center mb-4">
                <div class="preview-amount-circle mx-auto mb-3">
                  <span class="fw-bold fs-3">{{ formatCurrency(creditPreview.amount) }}</span>
                </div>
                <h5>Credit to {{ creditPreview.user.username }}</h5>
              </div>
              
              <div class="credit-details bg-light p-3 rounded-3 mb-3">
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">User:</span>
                  <span class="fw-semibold">{{ creditPreview.user.username }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">Current Balance:</span>
                  <span class="fw-bold">{{ formatCurrency(creditPreview.user.balance) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">Credit Amount:</span>
                  <span class="fw-bold text-success">+{{ formatCurrency(creditPreview.amount) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">New Balance:</span>
                  <span class="fw-bold text-success">{{ formatCurrency(creditPreview.userBalanceAfter) }}</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">Parent User:</span>
                  <span class="fw-semibold">{{ creditPreview.parent?.username || 'None' }}</span>
                </div>
                <div *ngIf="creditPreview.parent" class="d-flex justify-content-between">
                  <span class="text-muted">Parent Balance After:</span>
                  <span class="fw-bold" [class.text-danger]="creditPreview.parentBalanceAfter < 0">
                    {{ formatCurrency(creditPreview.parentBalanceAfter) }}
                  </span>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Description:</span>
                  <span class="fst-italic">{{ creditPreview.description }}</span>
                </div>
              </div>
              
              <div *ngIf="creditPreview.parentBalanceAfter < 0" class="alert alert-warning mb-0">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                Warning: Parent balance will become negative after this credit.
              </div>
            </div>
            
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" (click)="closePreview()">
                <i class="bi bi-x-circle me-2"></i>
                Cancel
              </button>
              <button 
                type="button" 
                class="btn btn-success"
                (click)="onSubmit()"
                [disabled]="isProcessing">
                <span *ngIf="!isProcessing">
                  <i class="bi bi-check-circle me-2"></i>
                  Confirm Credit
                </span>
                <span *ngIf="isProcessing">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Processing...
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar - Credit History -->
    <div class="col-lg-4">
      <!-- Recent Credits Card -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light py-3">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-clock-history text-primary me-2"></i>
            Recent Credits
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <div *ngFor="let credit of creditHistory" class="list-group-item border-0 py-3">
              <div class="d-flex align-items-center">
                <div class="credit-icon bg-success bg-opacity-10 rounded-2 p-2 me-3">
                  <i class="bi bi-cash-coin text-success"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">{{ credit.user }}</span>
                    <span class="fw-bold text-success">+{{ formatCurrency(credit.amount) }}</span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-1">
                    <small class="text-muted">
                      <i class="bi bi-person me-1"></i> {{ credit.creditedBy }}
                    </small>
                    <small class="text-muted">
                      <i class="bi bi-clock me-1"></i> {{ formatDate(credit.date) }}
                    </small>
                  </div>
                  <small class="text-muted d-block mt-1">
                    <i class="bi bi-chat me-1"></i> {{ credit.description }}
                  </small>
                </div>
              </div>
            </div>
            <div *ngIf="creditHistory.length === 0" class="list-group-item text-center py-4">
              <i class="bi bi-cash-stack display-6 text-muted mb-3"></i>
              <p class="text-muted mb-0">No recent credits</p>
            </div>
          </div>
        </div>
        <div class="card-footer bg-light text-center py-2">
          <a routerLink="/statement" class="text-decoration-none small">
            View All Transactions <i class="bi bi-arrow-right ms-1"></i>
          </a>
        </div>
      </div>

      <!-- Credit Guidelines Card -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-light py-3">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-info-circle text-info me-2"></i>
            Credit Guidelines
          </h5>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            <li class="d-flex mb-3">
              <i class="bi bi-check-circle-fill text-success me-2 flex-shrink-0"></i>
              <span class="small">Amount will be deducted from the user's immediate parent balance</span>
            </li>
            <li class="d-flex mb-3">
              <i class="bi bi-check-circle-fill text-success me-2 flex-shrink-0"></i>
              <span class="small">Maximum credit amount per transaction: $1,000,000</span>
            </li>
            <li class="d-flex mb-3">
              <i class="bi bi-check-circle-fill text-success me-2 flex-shrink-0"></i>
              <span class="small">Description is required for audit purposes</span>
            </li>
            <li class="d-flex mb-3">
              <i class="bi bi-check-circle-fill text-success me-2 flex-shrink-0"></i>
              <span class="small">Credits are recorded in the transaction history</span>
            </li>
            <li class="d-flex">
              <i class="bi bi-check-circle-fill text-success me-2 flex-shrink-0"></i>
              <span class="small">User will receive notification if enabled</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Credit Section -->
  <div *ngIf="showBulkCredit" class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-warning text-dark py-3">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-people-fill me-2"></i>
            Bulk Credit by Level
          </h5>
          <p class="mb-0 small opacity-75">
            Credit the same amount to multiple users at the same level
          </p>
        </div>
        
        <div class="card-body p-4">
          <form [formGroup]="bulkCreditForm">
            <div class="row">
              <!-- Level Selection -->
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-layers me-1"></i>
                  Select Level
                  <span class="text-danger">*</span>
                </label>
                <select class="form-select" formControlName="level" [class.is-invalid]="isFieldInvalid(bulkCreditForm, 'level')">
                  <option value="">Choose level...</option>
                  <option *ngFor="let level of availableLevels" [value]="level">Level {{ level }}</option>
                </select>
                <div *ngIf="isFieldInvalid(bulkCreditForm, 'level')" class="invalid-feedback d-block">
                  Please select a level
                </div>
              </div>

              <!-- Amount Field -->
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-currency-dollar me-1"></i>
                  Amount per User
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light">$</span>
                  <input
                    type="number"
                    class="form-control"
                    formControlName="amount"
                    placeholder="Enter amount"
                    [class.is-invalid]="isFieldInvalid(bulkCreditForm, 'amount')"
                    min="1"
                    max="100000"
                  >
                </div>
                <div *ngIf="isFieldInvalid(bulkCreditForm, 'amount')" class="invalid-feedback d-block">
                  {{ getErrorMessage(bulkCreditForm, 'amount') }}
                </div>
              </div>

              <!-- Description Field -->
              <div class="col-12 mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-chat-text me-1"></i>
                  Description
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="description"
                  placeholder="Reason for bulk credit"
                  [class.is-invalid]="isFieldInvalid(bulkCreditForm, 'description')"
                >
                <div *ngIf="isFieldInvalid(bulkCreditForm, 'description')" class="invalid-feedback d-block">
                  {{ getErrorMessage(bulkCreditForm, 'description') }}
                </div>
              </div>

              <!-- Filter Options -->
              <div class="col-12 mb-4">
                <label class="form-label fw-semibold">Filter Options</label>
                <div class="bg-light p-3 rounded-3">
                  <div class="row">
                    <div class="col-md-4">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" formControlName="excludeInactive">
                        <label class="form-check-label fw-semibold">
                          Exclude Inactive
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" formControlName="excludeAdmins">
                        <label class="form-check-label fw-semibold">
                          Exclude Admins
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" formControlName="excludeOwners">
                        <label class="form-check-label fw-semibold">
                          Exclude Owners
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-end gap-2">
              <button 
                type="button" 
                class="btn btn-outline-secondary"
                (click)="toggleBulkCredit()">
                <i class="bi bi-x-circle me-2"></i>
                Cancel
              </button>
              
              <button 
                type="button" 
                class="btn btn-warning px-4"
                (click)="onBulkSubmit()"
                [disabled]="bulkCreditForm.invalid || isProcessing">
                <span *ngIf="!isProcessing">
                  <i class="bi bi-people-fill me-2"></i>
                  Process Bulk Credit
                </span>
                <span *ngIf="isProcessing">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Processing...
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Bulk Credit Info -->
      <div class="card shadow-sm border-0 mt-4">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <i class="bi bi-info-circle-fill text-info fs-4 me-3"></i>
            <div>
              <h6 class="fw-semibold mb-1">About Bulk Credit</h6>
              <p class="text-muted small mb-0">
                Bulk credit will add the specified amount to all eligible users at the selected level.
                The amount will be deducted from each user's parent balance. This action cannot be undone.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Backdrop -->
  <div class="modal-backdrop fade show" *ngIf="showPreview" (click)="closePreview()"></div>
</div>