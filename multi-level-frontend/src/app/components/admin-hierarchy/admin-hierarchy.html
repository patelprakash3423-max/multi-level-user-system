<div class="admin-hierarchy-container">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-gradient-admin text-white py-3">
          <div class="d-flex flex-wrap align-items-center justify-content-between">
            <div class="d-flex align-items-center mb-2 mb-md-0">
              <button class="btn btn-light btn-sm me-3" (click)="goBack()">
                <i class="bi bi-arrow-left"></i>
              </button>
              <i class="bi bi-diagram-3-fill fs-1 me-3"></i>
              <div>
                <h2 class="mb-0 fw-bold">Hierarchy Viewer</h2>
                <p class="mb-0 opacity-75">
                  View complete downline network for any user
                </p>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button *ngIf="rootUser" class="btn btn-light btn-sm" (click)="exportHierarchy()">
                <i class="bi bi-download me-1"></i> Export
              </button>
              <button *ngIf="rootUser" class="btn btn-light btn-sm" (click)="printHierarchy()">
                <i class="bi bi-printer me-1"></i> Print
              </button>
              <button class="btn btn-light btn-sm" (click)="loadAnotherUser()">
                <i class="bi bi-search me-1"></i> New Search
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Search Section (shown when no hierarchy loaded) -->
  <div *ngIf="!rootUser && !isLoadingHierarchy" class="row mb-4">
    <div class="col-lg-8 mx-auto">
      <div class="card shadow-sm border-0">
        <div class="card-body text-center p-5">
          <div class="search-icon mb-4">
            <i class="bi bi-diagram-3 display-1 text-primary"></i>
          </div>
          <h3 class="fw-bold mb-3">View User Hierarchy</h3>
          <p class="text-muted mb-4">
            Enter a username or user ID to view their complete downline network
          </p>
          
          <div class="row justify-content-center">
            <div class="col-md-8">
              <div class="position-relative">
                <div class="input-group input-group-lg">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="bi bi-person-badge"></i>
                  </span>
                  <input
                    type="text"
                    class="form-control border-start-0 ps-0"
                    placeholder="Search by username or email..."
                    [(ngModel)]="searchUsername"
                    (keyup.enter)="searchUser()"
                  >
                  <button class="btn btn-primary" type="button" (click)="searchUser()" [disabled]="isSearching">
                    <span *ngIf="!isSearching">
                      <i class="bi bi-search me-2"></i> Search
                    </span>
                    <span *ngIf="isSearching">
                      <span class="spinner-border spinner-border-sm me-2"></span>
                      Searching...
                    </span>
                  </button>
                </div>
                
                <!-- Search Results Dropdown -->
                <div *ngIf="showSearchResults && searchResults.length > 0" class="search-results card position-absolute w-100 mt-1" style="z-index: 1000;">
                  <div class="list-group list-group-flush">
                    <button 
                      *ngFor="let user of searchResults"
                      class="list-group-item list-group-item-action d-flex align-items-center"
                      (click)="selectUser(user)">
                      <div class="user-avatar me-3" [ngClass]="'bg-' + getAvatarColor(user.username) + '-subtle'">
                        <span class="avatar-text">{{ getInitials(user.username) }}</span>
                      </div>
                      <div class="flex-grow-1 text-start">
                        <div class="fw-semibold">{{ user.username }}</div>
                        <small class="text-muted">{{ user.email }} • Level {{ user.level }} • {{ user.role | titlecase }}</small>
                      </div>
                      <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
                        {{ user.role | titlecase }}
                      </span>
                    </button>
                  </div>
                </div>
                
                <div *ngIf="showSearchResults && searchResults.length === 0 && !isSearching" class="search-results card position-absolute w-100 mt-1">
                  <div class="list-group-item text-center text-muted py-3">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    No users found
                  </div>
                </div>
              </div>
              
              <div class="mt-4">
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  You can also search by User ID or email address
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoadingHierarchy" class="text-center py-5">
    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <h5 class="mt-4 text-muted">Loading hierarchy...</h5>
    <p class="text-muted">Building network structure</p>
  </div>

  <!-- Hierarchy Display -->
  <div *ngIf="rootUser && !isLoadingHierarchy">
    <!-- User Info Card -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-6">
                <div class="d-flex align-items-center">
                  <div class="root-user-avatar me-3" [ngClass]="'bg-' + getAvatarColor(rootUser.username) + '-subtle'">
                    <span class="avatar-text">{{ getInitials(rootUser.username) }}</span>
                  </div>
                  <div>
                    <div class="d-flex align-items-center gap-2 mb-1">
                      <h4 class="fw-bold mb-0">{{ rootUser.username }}</h4>
                      <span class="badge" [ngClass]="getRoleBadgeClass(rootUser.role)">
                        {{ rootUser.role | titlecase }}
                      </span>
                      <span class="badge bg-secondary">Level {{ rootUser.level }}</span>
                    </div>
                    <p class="text-muted mb-1">
                      <i class="bi bi-envelope me-1"></i> {{ rootUser.email }}
                    </p>
                    <p class="text-muted mb-0">
                      <i class="bi bi-people me-1"></i> {{ totalNodes }} users in network • {{ totalLevels }} levels deep
                    </p>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="row g-2">
                  <div class="col-4">
                    <div class="stat-card-small bg-light p-2 rounded-3 text-center">
                      <span class="text-muted d-block small">Network Size</span>
                      <span class="fw-bold fs-5">{{ formatNumber(totalNodes) }}</span>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="stat-card-small bg-light p-2 rounded-3 text-center">
                      <span class="text-muted d-block small">Total Balance</span>
                      <span class="fw-bold fs-5 text-success">{{ formatCurrency(totalBalance) }}</span>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="stat-card-small bg-light p-2 rounded-3 text-center">
                      <span class="text-muted d-block small">Active Users</span>
                      <span class="fw-bold fs-5 text-primary">{{ activeUsers }}/{{ totalNodes }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                <i class="bi bi-layers-fill fs-3 text-primary"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">Network Depth</h6>
                <h3 class="mb-0 fw-bold">{{ totalLevels }}</h3>
                <small class="text-muted">Maximum levels</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-success bg-opacity-10 rounded-3 p-3 me-3">
                <i class="bi bi-person-check-fill fs-3 text-success"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">Active Users</h6>
                <h3 class="mb-0 fw-bold">{{ activeUsers }}</h3>
                <small class="text-success">
                  {{ ((activeUsers / totalNodes) * 100 | number:'1.0-1') || 0 }}% active
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                <i class="bi bi-person-dash-fill fs-3 text-warning"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">Inactive Users</h6>
                <h3 class="mb-0 fw-bold">{{ inactiveUsers }}</h3>
                <small class="text-danger">
                  {{ ((inactiveUsers / totalNodes) * 100 | number:'1.0-1') || 0 }}% inactive
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-info bg-opacity-10 rounded-3 p-3 me-3">
                <i class="bi bi-arrow-branch fs-3 text-info"></i>
              </div>
              <div>
                <h6 class="text-muted mb-1">Branch Factor</h6>
                <h3 class="mb-0 fw-bold">{{ (totalNodes / totalLevels | number:'1.0-1') || 0 }}</h3>
                <small class="text-muted">Avg users per level</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Level Distribution -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-light d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0 fw-semibold">
              <i class="bi bi-bar-chart-steps text-primary me-2"></i>
              Level Distribution
            </h5>
            <span class="badge bg-primary">{{ totalLevels }} Levels</span>
          </div>
          <div class="card-body">
            <div class="level-distribution">
              <div *ngFor="let level of (levelDistribution | keyvalue)" class="level-bar-item mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span class="fw-semibold">Level {{ level.key }}</span>
                  <div>
                    <span class="badge me-2" [ngClass]="getLevelClass(+level.key)">
                      {{ level.value }} users
                    </span>
                    <span class="text-muted small">
                      {{ ((level.value / totalNodes) * 100 | number:'1.0-1') }}%
                    </span>
                  </div>
                </div>
                <div class="progress" style="height: 8px;">
                  <div 
                    class="progress-bar" 
                    [ngClass]="'level-progress-' + level.key"
                    [style.width.%]="getProgressPercentage(+level.key)"
                    role="progressbar">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls Bar -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="row g-3">
              <!-- View Mode -->
              <div class="col-lg-3">
                <label class="form-label fw-semibold">View Mode</label>
                <div class="btn-group w-100" role="group">
                  <button 
                    type="button" 
                    class="btn" 
                    [class.btn-primary]="viewMode === 'tree'" 
                    [class.btn-outline-secondary]="viewMode !== 'tree'"
                    (click)="setViewMode('tree')">
                    <i class="bi bi-diagram-3 me-1"></i> Tree
                  </button>
                  <button 
                    type="button" 
                    class="btn" 
                    [class.btn-primary]="viewMode === 'org'" 
                    [class.btn-outline-secondary]="viewMode !== 'org'"
                    (click)="setViewMode('org')">
                    <i class="bi bi-people me-1"></i> Org
                  </button>
                  <button 
                    type="button" 
                    class="btn" 
                    [class.btn-primary]="viewMode === 'list'" 
                    [class.btn-outline-secondary]="viewMode !== 'list'"
                    (click)="setViewMode('list')">
                    <i class="bi bi-list-ul me-1"></i> List
                  </button>
                </div>
              </div>

              <!-- Search in Hierarchy -->
              <div class="col-lg-4">
                <label class="form-label fw-semibold">Search in Network</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="bi bi-search"></i>
                  </span>
                  <input
                    type="text"
                    class="form-control border-start-0 ps-0"
                    placeholder="Search by name, email, role..."
                    (input)="searchInHierarchy($event)"
                  >
                </div>
              </div>

              <!-- Display Options -->
              <div class="col-lg-5">
                <label class="form-label fw-semibold">Display Options</label>
                <div class="d-flex flex-wrap gap-2">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" [(ngModel)]="showBalances">
                    <label class="form-check-label">Show Balances</label>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" [(ngModel)]="showEmails">
                    <label class="form-check-label">Show Emails</label>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" [(ngModel)]="showInactive" (change)="toggleInactiveUsers()">
                    <label class="form-check-label">Show Inactive</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tree Controls -->
            <div class="row mt-3">
              <div class="col-12">
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-sm btn-outline-primary" (click)="expandAll()">
                    <i class="bi bi-arrows-expand me-1"></i> Expand All
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" (click)="collapseAll()">
                    <i class="bi bi-arrows-collapse me-1"></i> Collapse All
                  </button>
                  <button class="btn btn-sm btn-outline-success" (click)="expandLevel(1)">
                    <i class="bi bi-layers me-1"></i> Level 1
                  </button>
                  <button class="btn btn-sm btn-outline-info" (click)="expandLevel(2)">
                    <i class="bi bi-layers me-1"></i> Level 2
                  </button>
                  <button class="btn btn-sm btn-outline-warning" (click)="expandLevel(3)">
                    <i class="bi bi-layers me-1"></i> Level 3
                  </button>
                  <button class="btn btn-sm btn-outline-danger" (click)="expandLevel(4)">
                    <i class="bi bi-layers me-1"></i> Level 4
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tree View -->
    <div *ngIf="viewMode === 'tree'" class="row">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-body p-4">
            <div class="tree-view">
              <div *ngIf="filteredTree.length === 0" class="text-center py-4">
                <i class="bi bi-exclamation-circle display-4 text-muted mb-3"></i>
                <p class="text-muted">No users match the current filters</p>
              </div>
              
              <div *ngFor="let node of filteredTree" class="tree-node-root">
                <div class="hierarchy-node-wrapper">
                  <!-- Root Node -->
                  <div class="hierarchy-node root-node">
                    <div class="node-content" [ngClass]="getLevelClass(1)">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center flex-grow-1">
                          <div class="node-icon me-2">
                            <div class="user-avatar" [ngClass]="'bg-' + getAvatarColor(node.username) + '-subtle'">
                              <span class="avatar-text">{{ getInitials(node.username) }}</span>
                            </div>
                          </div>
                          
                          <div class="node-info">
                            <div class="d-flex align-items-center gap-2 mb-1">
                              <span class="fw-bold">{{ node.username }}</span>
                              <span class="badge" [ngClass]="getRoleBadgeClass(node.role)">
                                {{ node.role | titlecase }}
                              </span>
                              <span class="badge bg-secondary">Level {{ node.level }}</span>
                              <span class="badge" [ngClass]="getStatusBadgeClass(node.isActive)">
                                {{ getStatusText(node.isActive) }}
                              </span>
                            </div>
                            <div class="node-meta">
                              <small *ngIf="showEmails" class="text-muted me-3">
                                <i class="bi bi-envelope me-1"></i> {{ node.email }}
                              </small>
                              <small *ngIf="showBalances" class="text-muted me-3">
                                <i class="bi bi-cash-stack me-1"></i> {{ formatCurrency(node.balance || 0) }}
                              </small>
                              <small class="text-muted">
                                <i class="bi bi-people me-1"></i> {{ node.downlineCount || 0 }} downline
                              </small>
                            </div>
                          </div>
                        </div>

                        <div class="node-actions">
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" (click)="viewUserDetails(node._id)" title="View Details">
                              <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-success" (click)="creditUser(node._id, node.username)" title="Credit Balance">
                              <i class="bi bi-cash-coin"></i>
                            </button>
                            <button class="btn btn-outline-warning" (click)="changeUserPassword(node)" title="Change Password">
                              <i class="bi bi-key"></i>
                            </button>
                            <button 
                              class="btn" 
                              [class.btn-outline-danger]="node.isActive" 
                              [class.btn-outline-success]="!node.isActive"
                              (click)="toggleUserStatus(node)"
                              [title]="node.isActive ? 'Deactivate' : 'Activate'">
                              <i class="bi" [class.bi-pause-circle]="node.isActive" [class.bi-play-circle]="!node.isActive"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Children Container -->
                  <div class="node-children" *ngIf="filteredTree.length > 0">
                    <div class="children-wrapper">
                      <app-hierarchy-node
                        *ngFor="let child of node.children"
                        [node]="child"
                        [level]="2"
                        [expanded]="isNodeExpanded(child._id)"
                        [showBalances]="showBalances"
                        [showEmails]="showEmails"
                        (toggle)="toggleNode(child)"
                        (viewDetails)="viewUserDetails($event)"
                        (credit)="creditUser($event, child.username)"
                        (changePassword)="changeUserPassword(child)"
                        (toggleStatus)="toggleUserStatus(child)"
                      ></app-hierarchy-node>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Org Chart View -->
    <div *ngIf="viewMode === 'org'" class="row">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="org-chart">
              <div class="org-node root-org-node text-center mb-4">
                <div class="org-card p-3 bg-primary text-white rounded-3 d-inline-block">
                  <div class="org-avatar mb-2">
                    <i class="bi bi-person-circle fs-1"></i>
                  </div>
                  <h5 class="mb-1">{{ rootUser.username }}</h5>
                  <span class="badge bg-light text-dark">{{ rootUser.role }}</span>
                  <div class="mt-2">
                    <small>Level {{ rootUser.level }}</small>
                  </div>
                </div>
              </div>
              
              <div class="org-children d-flex justify-content-around flex-wrap">
                <div *ngFor="let node of filteredTree" class="org-child">
                  <div class="org-card p-3 bg-light rounded-3 text-center">
                    <div class="org-avatar mb-2">
                      <div class="user-avatar mx-auto" [ngClass]="'bg-' + getAvatarColor(node.username) + '-subtle'">
                        <span class="avatar-text">{{ getInitials(node.username) }}</span>
                      </div>
                    </div>
                    <h6 class="mb-1 fw-bold">{{ node.username }}</h6>
                    <span class="badge mb-2" [ngClass]="getRoleBadgeClass(node.role)">{{ node.role }}</span>
                    <div class="small">
                      <div *ngIf="showBalances" class="text-success fw-bold">{{ formatCurrency(node.balance || 0) }}</div>
                      <div class="text-muted">Downline: {{ node.downlineCount || 0 }}</div>
                    </div>
                    <div class="mt-2">
                      <button class="btn btn-sm btn-outline-primary" (click)="viewUserDetails(node._id)">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  
                  <!-- Second Level -->
                  <div *ngIf="node.children && node.children.length > 0" class="org-subchildren mt-3 d-flex justify-content-center flex-wrap gap-2">
                    <div *ngFor="let child of node.children.slice(0, 3)" class="org-subchild">
                      <div class="org-card-sm p-2 bg-light rounded-3 text-center" style="width: 150px;">
                        <span class="fw-semibold d-block">{{ child.username }}</span>
                        <small class="text-muted">{{ child.role }}</small>
                        <div class="mt-1">
                          <button class="btn btn-xs btn-outline-primary" (click)="viewUserDetails(child._id)">
                            <i class="bi bi-eye"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    <div *ngIf="node.children.length > 3" class="org-more">
                      <span class="badge bg-secondary">+{{ node.children.length - 3 }} more</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- List View -->
    <div *ngIf="viewMode === 'list'" class="row">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="ps-4">User</th>
                    <th>Role</th>
                    <th>Level</th>
                    <th>Balance</th>
                    <th>Downline</th>
                    <th>Status</th>
                    <th>Parent</th>
                    <th class="pe-4">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let node of flattenHierarchy(filteredTree)">
                    <td class="ps-4">
                      <div class="d-flex align-items-center">
                        <div class="user-avatar-sm me-2" [ngClass]="'bg-' + getAvatarColor(node.username) + '-subtle'">
                          <span class="avatar-text">{{ getInitials(node.username) }}</span>
                        </div>
                        <div>
                          <span class="fw-semibold d-block">{{ node.username }}</span>
                          <small class="text-muted">{{ node.email }}</small>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="badge" [ngClass]="getRoleBadgeClass(node.role)">
                        {{ node.role | titlecase }}
                      </span>
                    </td>
                    <td>
                      <span class="badge" [ngClass]="getLevelClass(node.level || 1)">
                        Level {{ node.level }}
                      </span>
                    </td>
                    <td class="fw-semibold">{{ formatCurrency(node.balance || 0) }}</td>
                    <td>
                      <span class="badge bg-info bg-opacity-10 text-info">
                        {{ node.downlineCount || 0 }}
                      </span>
                    </td>
                    <td>
                      <span class="badge" [ngClass]="getStatusBadgeClass(node.isActive)">
                        {{ node.isActive ? 'Active' : 'Inactive' }}
                      </span>
                    </td>
                    <td>
                      <small class="text-muted">{{ node.parentId || 'Root' }}</small>
                    </td>
                    <td class="pe-4">
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" (click)="viewUserDetails(node._id)" title="View Details">
                          <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-success" (click)="creditUser(node._id, node.username)" title="Credit Balance">
                          <i class="bi bi-cash-coin"></i>
                        </button>
                        <button class="btn btn-outline-warning" (click)="changeUserPassword(node)" title="Change Password">
                          <i class="bi bi-key"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>